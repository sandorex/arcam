#!/usr/bin/env bash
# starts a new box in current directory

set -e -o pipefail

ENGINE="${BOX_ENGINE:-podman}"

POSITIONAL_ARGS=()

DOTFILES=''
INTERACTIVE=0
DEBUG=0

while [ $# -gt 0 ]; do
    case $1 in
        --dotfiles)
            DOTFILES="$2"
            shift 2
            ;;
        -i|--interactive)
            INTERACTIVE=1
            shift
            ;;
        --debug)
            DEBUG=1
            shift
            ;;
        -*)
            echo "Unknown option $1"
            exit 1
            ;;
        *)
            # save positional arg
            POSITIONAL_ARGS+=("$1")
            shift
            ;;
    esac
done

# restore positional parameters
set -- "${POSITIONAL_ARGS[@]}"

IMAGE="${1:-box-fedora}"

# data volume used for persistant things like neovim plugins for example
# NOTE using volume inspect as it works on both podman and docker
if ! command "$ENGINE" volume inspect box-data &>/dev/null; then
    command "$ENGINE" volume create box-data &>/dev/null
fi

# find all terminfo as debian has them scattered around
args=()
for i in /usr/share/terminfo /usr/lib/terminfo /etc/terminfo; do
    if [[ -d "$i" ]]; then
        args+=(--volume "$i:/host$i:ro")
    fi
done

# prefer argument dotfiles than env var
if [[ -n "$DOTFILES" ]]; then
    args+=(--volume "$DOTFILES:/etc/skel:ro")
elif [[ -n "$BOX_DOTFILES" ]]; then
    args+=(--volume "$BOX_DOTFILES:/etc/skel:ro")
fi

if [[ "$INTERACTIVE" -eq "1" ]]; then
    # run attached with tty and stdin
    args+=(-it)
else
    # run detached
    args+=(-d)
fi

# enter bash without running init
if [[ "$DEBUG" -eq "1" ]]; then
    args+=(--entrypoint bash)
fi

# TODO docker does not support --userns=keep-id
# TODO print errors to stderr so stdout can be saved for the ID
exec "$ENGINE" run --rm \
    --security-opt label=disable \
    --user root \
    --userns=keep-id \
    --label=manager=box \
    --label="box=box" \
    --env "HOST_USER=$USER" \
    --env TERMINFO_DIRS=/host/usr/share/terminfo:/host/usr/lib/terminfo:/host/etc/terminfo:/usr/share/terminfo:/usr/lib/terminfo:/etc/terminfo \
    "${args[@]}" \
    --volume box-data:/data:Z \
    --volume "$PWD:/ws:Z" \
    --hostname "$(hostname)" \
    "$IMAGE"

