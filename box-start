#!/usr/bin/env bash
# starts a new box in current directory

set -e -o pipefail

# TODO check if these all match
VERSION='0.1'

ENGINE="${BOX_ENGINE:-podman}"

POSITIONAL_ARGS=()

DOTFILES=''
NETWORK=1

while [ $# -gt 0 ]; do
    case $1 in
        --dotfiles)
            DOTFILES="$2"
            shift 2
            ;;
        -nn|--no-network)
            NETWORK=0
            shift
            ;;
        -*)
            echo "Unknown option $1"
            exit 1
            ;;
        *)
            # save positional arg
            POSITIONAL_ARGS+=("$1")
            shift
            ;;
    esac
done

# restore positional parameters
set -- "${POSITIONAL_ARGS[@]}"

IMAGE="${1:-box-fedora}"
shift || true

# data volume used for persistant things like neovim plugins for example
# NOTE using volume inspect as it works on both podman and docker
if ! command "$ENGINE" volume inspect box-data &>/dev/null; then
    command "$ENGINE" volume create box-data &>/dev/null
fi

# find all terminfo as debian has them scattered around
args=()
for i in /usr/share/terminfo /usr/lib/terminfo /etc/terminfo; do
    if [[ -d "$i" ]]; then
        args+=(--volume "$i:/host$i:ro")
    fi
done

# prefer argument dotfiles than env var
if [[ -n "$DOTFILES" ]]; then
    args+=(--volume "$DOTFILES:/etc/skel:ro")
elif [[ -n "$BOX_DOTFILES" ]]; then
    args+=(--volume "$BOX_DOTFILES:/etc/skel:ro")
fi

# network is on by default, so disable it if requested
if [[ "$NETWORK" -eq "0" ]]; then
    args+=(--network=none)
fi

# TODO print the name not the ID
# TODO docker does not support --userns=keep-id

# the bash -c mess is so it waits until init file is pushed to container cause
# i do not want to manually delete containers later if i remove '--rm' flag
CONTAINER_ID=$("$ENGINE" run -d --rm \
    --security-opt label=disable \
    --user root \
    --userns=keep-id \
    --label=manager=box \
    --label="box=$ENGINE" \
    --env "BOX=$ENGINE" \
    --env "BOX_VERSION=$VERSION" \
    --env "HOST_USER=$USER" \
    --env TERMINFO_DIRS=/host/usr/share/terminfo:/host/usr/lib/terminfo:/host/etc/terminfo:/usr/share/terminfo:/usr/lib/terminfo:/etc/terminfo \
    "${args[@]}" \
    --volume box-data:/data:Z \
    --volume "$PWD:/ws:Z" \
    --hostname "$(hostname)" \
    --entrypoint /bin/bash \
    "$@" \
    "$IMAGE" \
    -c \
    'while [[ ! -f /init ]]; do sleep 0.1s; done; echo done; exec /init'
)

# copy init
command "$ENGINE" cp box-init "$CONTAINER_ID:/init"
