#!/usr/bin/expect -f

log_file test_all_in_one.log
set timeout 10

send "Test Begin: all in one\n"

send_user "\nTesting start command\n"
spawn arcam start docker.io/library/debian:bookworm-slim
expect {
    -re {^[A-Za-z]+-arcam\r\n$} { }
    timeout { exit 1 }
    eof { exit 1 }
}
wait

send_user "\n"

# make sure it does not start again in the same directory
spawn arcam start docker.io/library/debian:bookworm-slim
expect {
    "already running" { }
    timeout { exit 1 }
    eof { exit 1 }
}
wait

send_user "\nTesting exec command\n"
spawn arcam exec -- stat -c "%n %F" /
expect {
    -ex "/ directory" { }
    timeout { exit 1 }
    eof { exit 1 }
}
wait

send_user "\nTesting shell command\n"
spawn arcam shell
sleep 1
expect -re {\$ *$}
send "stat -c '%n %F' /\r"
sleep 1
expect -ex "/ directory"
send "exit\r"
sleep 1
expect "logout"
expect eof
wait

send_user "\nTesting kill command\n"
spawn arcam kill
expect {
    # basically match [y/N]
    -re {\[[yY]/[nN]\] $} { send "y\r"; send_user "\n" }
    timeout { exit 1 }
    eof { exit 1 }
}
wait

send_user "\nTest End: all in one\n"

